---
title: "Covid-19 Trends on the Global Level"
author: "Emma Strawbridge, Lynca Kaminka, Tabitha Tatusko"
date: "May 9th, 2023"
output:
  rmdformats::readthedown:
    highlight: "kate"
---

```{r setup, include = FALSE, warnings=FALSE, message=FALSE, echo = FALSE}
# Set code chunk defaults 
# Consider adding `message = FALSE` option
#knitr::opts_chunk$set(echo = FALSE) 
                      
# Set R environment options
options(knitr.kable.NA = '')

# Load packages
library(tidyverse)
library(lubridate)
library(dplyr)
library(readxl)
library(ggrepel)
library(broom)
library(GGally)
library(purrr)
library(kableExtra)
library(plotly)
library(scales)
library(janitor)
library(datasets)
library(textdata)
library(stringr)
library(wordcloud)
library(tidyr)
library(ical)
library(DT)
library(tidytuesdayR)
library(shinythemes)
library(stringi)
library(ggthemes)
library(gridExtra) 
library(knitr)
library(ggplot2)
library(RMariaDB)
# help with extracting the right data frames from xlsx
library(readr)
library(sf)
library(rvest) #for web scrapijng
library(robotstxt) #checking if paths are allowed
library(rgeos)
library(rworldmap)
library(rworldxtra)
library(crosstalk) #for crosstalk. 
library(htmlwidgets)
library(bslib) # framework that allows one to style their Shiny applications and R Markdown documents with pre-build Bootstrap (open-source library created by Twitter) themes.
library(reactable)
library(leaflet)

#my laptop is funky and particular and only wants to read files in this way >:( But I'm pretty sure that if you set your session to the appropriate folder (blog2-SunnyDay) and then read from /emma/data/biggie.csv
#data <- read.csv("~/Desktop/RStudio231/2-strawbridge-emma/blog2-SunnyDay/emma/data/biggie.csv")

# update this path to where your Dropbox folder with the covid_worldwide_7 data is located
# on your computer


data <- read.csv("emma/data/biggie.csv")
country_pubs <- readRDS(file = "tabitha blog work/data/pubs_by_country.RDs")
common_topics <- readRDS(file = "tabitha blog work/data/common_topics.RDs")

```

# Exploring worldwide Covid Data!



## Tabitha - Covid Publications Trends and Analysis

During the pandemic, scientists around the globe were putting all of their resources into better understanding Covid-19 and finding a vaccine. This led to an unprecedented level of scientific advancement and research, which is reflected in the scientific publications released to document these discoveries. For this analysis, I used data from Dimensions, the world's largest linked research database. The dataset I used encompasses all publications, datasets, and clinical trials from Dimensions pertaining to Covid-19 from March 2020 to September 2021, and can be accessed here. With such a comprehensive data source, I hoped to explore trends and similarities in Covid-related publications. Specifically, I wanted to analyze which countries contributed the most to Covid research efforts based on their publication amounts, and what the most common topics of interest were across all the Covid publications based on their titles.

#### Publications by Country

In order to examine publication prevalence by country, I used the country of research origin variable from the dataset to determine what country to assign each publication title to. Many of these publications are collaborations and had multiple authors, some from the same country and some from different countries. In those cases, I double-counted a specific publication title for multiple countries, but I did not double-count it for the same country. I figured that for the purpose of this analysis I wasn't interested in how many authors from each country were published, but rather how many publications were at least partially published with data from that country; therefore I didn't want the data skewed by say a publication with 5 authors all from the US counting as 5 different publications.

```{r echo=FALSE}
#ggplot barchart of publications by country 2020
country_pub_gg20 <- country_pubs %>%
  filter(pub_year == 2020) %>%
  slice(1:10) %>%
  ggplot(aes(x = fct_reorder(country, count), y = count, color = country, fill = country)) +
  geom_col() +
  # Rotate graph
  coord_flip() +
  guides(color = "none", 
         fill = "none") +
  labs(
    title = "Top 10 Publication Producing Countries in 2020",
    y = "Publication Count",
    x = "Country"
  )
 
#interactive plotly chart of publications by country
cpubs20_plotly <- ggplotly(country_pub_gg20, tooltip = "count") 
cpubs20_plotly
```

```{r}
#ggplot barchart of publications by country 2021
country_pub_gg21 <- country_pubs %>%
  filter(pub_year == 2021) %>%
  slice(1:10) %>%
  ggplot(aes(x = fct_reorder(country, count), y = count, color = country, fill = country)) +
  geom_col() +
  # Rotate graph
  coord_flip() +
  guides(color = "none", 
         fill = "none") +
  labs(
    title = "Top 10 Publication Producing Countries in 2021",
    y = "Publication Count",
    x = "Country"
  )
 
#interactive plotly chart of publications by country
cpubs21_plotly <- ggplotly(country_pub_gg21, tooltip = "count") 
cpubs21_plotly
```

Although everyone was working around the clock to find a vaccine, there were some countries that rose above with their amount of contributions. As you can see, in both 2020 and 2021 the United States was the top contributor of Covid related publications. The US had more than double the number of publications than the second and third most published countries, the United Kingdom and China. Additionally, although there is some movement between the two years, the same 10 countries had the most publications throughout the height of the pandemic.  

#### Most Common Publication Topics

Although the dataset I used on publications was pretty comprehensive, it didn't include the actual text of the papers. Since many of these papers also weren't open access, in order to analyze common topics I had to focus on the paper titles. While you would assume that the title of a paper accurately reflects the main topics of the writing, that is not always the case, so this topical analysis is far from perfect in its scope. Also, I removed the typical stop words for this analysis (from the stop_words dataset), but due to the medical and global context, there were some additional stop words I manually removed. These included stop words in other languages such as “de” and “la”, and words redundant to this analysis such as “Covid-19” and “2020”.

```{r echo=FALSE}
set.seed(12)
my_palette <- brewer.pal(9, "YlOrRd")[3:9]

#create common topics word cloud
common_topics %>%
  with(wordcloud(words = word, freq = count, max.words = 50,
                 # Specify the range of the size of the words
                 scale = c(3.2, 0.7),
                 # Specify proportion of words with 90 degree rotation
                 rot.per = 0.15,
                 # Color words from least to most frequent
                 colors = my_palette,
                 # Change font family
                 family = "serif"))

```

As you can see, many of the most common topics (based on the publication title) aren't directly about a vaccine. Many focus on Covid patients and their health, the severity of infection, or the impact of care received. Also, there is a common theme of learning and relation in these studies, which emphasizes how much of the research effort was exploratory due to how little we knew about the disease and its treatment. It is also important to note that all of these publications weren't clinical trials or even strictly medical; rather, they include any and all published papers (on Dimensions) that related to Covid in some way. So not all of these are strictly focused on the patient health aspect (although clearly many of them were), and it seems quite a few are general reviews of the existing literature suggesting possible future areas of study.

Although these visualizations are valuable tools in understanding the publications released on Covid during the height of the pandemic, there are several limitations to the conclusions we can draw from this data due to the manipulations necessary to perform these analyses. For example, all of the publications counted in both of these figures had to have titles written using the Latin alphabet, which means that English-speaking (or publishing) countries would be much more favored in the analysis. Also, some publications were excluded from these analyses that didn't have titles or countries assigned to them in the dataset, which could have been a flaw in the way the dataset was collected which may negatively affect certain countries.

```{r, warning = FALSE, echo = FALSE}
covid_worldwide_7 <- readRDS("data/covid_worldwide_data.RDS")
#importing the dataset. 
```


## Analysis of socio-economic factors that have influenced covid-19 cases from a global perspective.

In my analysis, I explored the distribution of COVID-19 parameters such as the per capita percentage of deaths, cases, and vaccinations, the distribution of those covid related observations, and the possible correlations between these parameters and the socio-economic determinants of each country. I took a country-by-country approach to comparing these values. Due to the restrictions inherent in the use of statistical tools such as graphs and tables, I had to restrict my analysis to the years 2021-2022. I chose this specific period because many countries were skeptical about covid-19 in 2022, and it was not declared a global pandemic until the end of March by the WHO. Moreover, we are at the beginning of 2023, so an annual analysis is also impossible.Although my analysis has focused on the distribution of the different observations related to covid-19 depending on various socio-economic factors, I must say that having an overview of the cumulative cases of covid per capita in 2 years through this process can also give a first glance outlook of how different countries have fared in that regard.

The following graph (that displays spatial data) illustrates the cumulative COVID-19 cases per capita  reported by all countries from January 2021 to December 2022. Additionally, the accompanying table provides a more detailed overview of COVID-19 related observations, including the cumulative per capita cases, deaths and vaccinations. 

The purpose of creating this graph was to illustrate the variation in per capita COVID-19 cases reported by different countries. This helps to identify contries that have been more severely affected by the pandemic compared to others; which is not always evident on a map view. This lays the foundation for further analysis of the potential socio-economic factors that may contribute to these trends.


```{r, warnings=FALSE, message=FALSE, echo = FALSE}
options(warn=-1)
covid_worldwide_7 <- covid_worldwide_7 %>%
    filter(!is.na(country) & country != "")%>%
    filter(gdp_per_capita != 0)%>%
    filter(life_expectancy != 0)%>%
    filter(aged_65_older != 0)
# we must remove any rows where the GDP per capita value equals 0 because no countries has a gdp_per_capita = 0, and where life_expectancy = 0. #for some reasons, some observations ended up being like that: 
#total counts

  covid_worldwide_dataT <- covid_worldwide_7 %>%
    select("country" | "continent" | "date"| "new_deaths_smoothed" |
             "new_cases_smoothed" | "new_tests_smoothed"| "new_vaccinations_smoothed" | "population" |"life_expectancy"|"aged_65_older" | iso_code | geom | longitude | latitude) %>%
    group_by(country, continent, population, life_expectancy, aged_65_older, latitude, longitude, geom, iso_code)%>%
    summarize(total_cases = sum(new_cases_smoothed), 
              total_deaths = sum(new_deaths_smoothed), 
              total_tests = sum(new_tests_smoothed), 
              total_vaccinations = sum(new_vaccinations_smoothed))%>%
    ungroup()
  
    
  #per capita counts
    covid_worldwide_dataT_capita <- covid_worldwide_dataT %>%
    select("country" | "continent" | "total_cases" |
             "total_deaths" | "total_tests"| "total_vaccinations" | "population" |"life_expectancy"|"aged_65_older" | iso_code | geom | longitude | latitude) %>%
    group_by(country, continent, population, life_expectancy, aged_65_older, latitude, longitude, geom, iso_code)%>%
    summarize(total_cases_capita = round((total_cases/population) * 100, 3),
              total_deaths_capita = round((total_deaths/population) *100, 3),
              total_tests_capita = round((total_tests/population) *100, 3),
              total_vaccinations_capita = round((total_vaccinations/population)*100,3))%>%
      ungroup()
    
    
#extracting only the desired pieces of information from the data set.
 covid_worldwide_leaflet_map <- covid_worldwide_dataT_capita %>%
   select("country", "continent", longitude, latitude, geom, total_cases_capita, total_deaths_capita)
 

 #transforming it into a leaflet object: 
 covid_worldwide_7_leaflet <- covid_worldwide_leaflet_map %>%
   st_as_sf()
 

 #caused me so much trouble but it is use to transform spatial data from one coordinate reference system (CRS) to another.From CRS to WGS84
 covid_worldwide_8_leaflet <- st_transform(covid_worldwide_7_leaflet, "+proj=longlat +datum=WGS84")
 

# Define a color palette 
my_palette <- colorQuantile(rev(viridis::viridis(20))
                  , domain =  covid_worldwide_8_leaflet$total_cases_capita, n=20)

# Create interactive map, zoomed in on Amherst
map <- leaflet(data = covid_worldwide_8_leaflet
         , options = leafletOptions(attributionControl = FALSE)) %>%
 # addTiles() %>%
   addPolygons(
      fillColor = ~my_palette(total_cases_capita),
       stroke = FALSE,
        popup = ~ glue::glue("Country: {str_to_title(country)}
                        <br> {paste0(round(total_cases_capita,2), '%')}")
      , weight = 2, smoothFactor = 0.5, opacity = 1, fillOpacity = 1
      , labelOptions= labelOptions(direction = 'auto')
      , color='#333333'
      , highlightOptions = highlightOptions(color='#000000', weight = 2
                                            , bringToFront = TRUE
                                            , sendToBack = TRUE)) %>%
   addLegend(pal = my_palette,
            values = covid_worldwide_8_leaflet$total_cases_capita,
           position = "topright",
           title = "Percentage of Per capita cases reported
            <br> (% 2021-2022)", opacity = 1)

```

```{r, warnings=FALSE, message=FALSE, echo = FALSE}
options(warn=-1)
# ungroup your dataframe
covid_worldwide_dataT_capita_ungrouped <- covid_worldwide_dataT_capita %>% 
  ungroup()
covid_worldwide_dataT_capita_table <- covid_worldwide_dataT_capita_ungrouped %>% 
  select("country" , total_cases_capita , total_deaths_capita , total_vaccinations_capita , total_tests_capita) 

#covid_worldwide_dataT_capita_table%>% 
  dataframe <- DT::datatable(covid_worldwide_dataT_capita_table, 
                colnames = c("Country", "Percentage of Covid-19 cases Per Capita", 
                         " Per Capita Percentage of  Deaths", 
                         " Per Capita Percentage of  Vaccinations", 
                         " Per Capita Percentage of  Tests"),
            filter = 'top',
            options = list(autoWidth = TRUE))

```



#### Country-level covid-19 view {.tabset}

##### Spatial View

```{r, warnings=FALSE, message=FALSE, echo = FALSE}
map
```
##### Table View

```{r, warnings=FALSE, message=FALSE, echo = FALSE}
dataframe
```

#### Some features about both representations: 

At a glance, Europe is the continent where most countries are reporting a higher cumulative covid cases per capita total compared to the rest of the world and some countries stand out like South Korea, Australia, Iceland. 

The other notable feature of the map is that some countries (the ones that are colored in Yellow) are reporting very low cumulative covid cases per capita total (Madagascar for example, it is reported that only/around $0.17%$ of the population seems to have caught covid ~ which is really small percentage). 
A look at the table gives a another story; among the countries with a close a zero percentage of covid-19 cases, we find Norht Korea (which is a Hermetic kingdom so this doesn't surprise)

A few countries (like Varican, Burundi, North Korea, Taiwan) report not having had any covid-19 related deaths in those two years which is a surprising factor. In general, the countries with the lowest percentage of covid-19 cases per capita seems to have an equally almost null covid-19 relatd e

#### Covid distribution in relation to other factors. 

As my first objective was to find a potential connecting thread between the socio-economic factors specific to each country and the fact that they were reflected in the observations associated with the pandemic, I undertook to analyze the progression of covid- 19 for each country and I have included filtering choices which allowed to visualize the countries whose socio-economic factor is in a certain range, say whose GDP is in a certain range, average age and so on. 

The important point to note is that there is a cost associated with using interactivity that is not integrated within Shiny. Specifically, the user experience with the graph isn't the most seamless, and it might take time for operations like range selector to take effect. 

#### Socio-economic factors and covid related observations.

##### Per Capita Percentage of Case Counts vs GDP Per Capita 

```{r, warnings=FALSE, message=FALSE, echo = FALSE}
covid_worldwide_8 <- covid_worldwide_7 %>%
  filter(!is.na(country) & country != "") 



covid_worldwide_9 <- covid_worldwide_8 %>%
  group_by(country, continent, date, extreme_poverty, gdp_per_capita, aged_65_older, life_expectancy,           
           diabetes_prevalence, population_density, population)%>%
    summarize(new_cases_smoothed_capita = round((new_cases_smoothed/population) *100, 3),
              new_deaths_smoothed_capita = round((new_deaths_smoothed/population) *100,3), 
              new_tests_smoothed_capita = round((new_tests_smoothed/population)*100,3),
              new_vaccinations_smoothed_capita = round((new_vaccinations_smoothed/population)*100,3))%>%
  ungroup()

covid_lines <- highlight_key(covid_worldwide_9)

gg_covid <- ggplot (data = covid_lines, aes(x=date, y = new_cases_smoothed_capita, group = country)) +
  geom_line(aes(color = continent,            
                text = paste("Country: ", country, 
                             "<br>Date: ", date, 
                              "<br> Per capita percentage of new covid cases", new_cases_smoothed_capita, "%",
                              "<br> Population Density", population_density, 
                              " <br> GDP per capita", gdp_per_capita
                        )), show.legend = FALSE)+
  xlab("Date") + ylab("Per capita percentage of new cases")+ 
  ggtitle("Per Capita Covid Cases Trend") +
  theme_bw()

 bscols(widths = c(3,9),
        list(
              filter_select("id", label = "Select a country", covid_lines, ~country),
              filter_slider(id = "slider_gdp_per_capita", label = " GDP Per Capita", 
                            covid_lines, column = ~gdp_per_capita)
             ), 
          ggplotly(gg_covid, dynamicTicks = TRUE, tooltip = c("text"),  
           tooltipoptions = list(placement = "bottom"))
 
)

```

Although the graph did not provide the level of detail I was hoping for, with most countries showing similar per capita percentages of COVID cases, there were a few countries whose per capita percentages increased dramatically or followed an unusual distribution. By utilizing crosstalk's interactive capabilities to limit the GDP ranges, I was able to uncover valuable insights. For example, when restricting the GDP per capita range from 20,000 to 59,000, the per capita percentage of new cases for those countries appeared to be constrained between 0 and 0.8. Similarly, for countries with higher GDP per capita (over 77,000, such as Qatar and Switzerland), the per capita percentage of new COVID cases was also constrained between 0 and 0.35.

However, for countries with lower GDP per capita, there was a greater range of variations in the per capita percentage of new cases. For instance, Marshall Islands (with a GDP per capita of 3,819) had new COVID cases counts that were as high as 3% of its total population, while Burundi (with a GDP per capita of 789) saw its highest per capita COVID cases at only 0.006. 


##### Per Capita Percentage of  Covid-induced Deaths vs GDP Life Expectancy and Proportion of 65+ people.

```{r, warnings=FALSE, message=FALSE, echo = FALSE}
covid_lines_2 <- highlight_key(covid_worldwide_9)

gg_covid_2 <- ggplot (data = covid_lines_2, aes(x=date, y = new_deaths_smoothed_capita, group = country)) +
  geom_line(aes(color = continent,            
                text = paste("Country: ", country, 
                             "<br>Date: ", date, 
                              "<br> Per capita percentage of new covid related deaths", new_deaths_smoothed_capita, "%", 
                              "<br> Life expectancy", life_expectancy, 
                             " <br> Aged 65 older", aged_65_older
                              
                              
                        )), show.legend = FALSE)+
  xlab("Date") + ylab("Per capita percentage of new covid related deaths")+ 
  ggtitle("Per Capita Covid Deaths Trend") +
  theme_bw()

 bscols(widths = c(3,9),
        list(
              filter_slider(id = "slider_le", label = "Life Expectancy", 
                            covid_lines_2, column = ~life_expectancy),
              filter_slider(id = "slider_aged70", label = "Aged 65 older", 
                            covid_lines_2, column = ~aged_65_older)
             ), 
          ggplotly(gg_covid_2, ddynamicTicks = TRUE, tooltip = c("text"),  
           tooltipoptions = list(placement = "bottom"))
 
)

```

At first glance, we can observe that the overall range of the per capita percentage of COVID-induced deaths is below 0.01%, which suggests that while COVID-19 is a health threat with unknown long-term ramifications, it is not as deadly as one might initially think when taking into account the high number of cases.

When examining specific life expectancy ranges, such as 53 to 67 and 67 to 81, the per capita percentage of daily COVID deaths ranges from 0.0000 to 0.0075. Most countries in these ranges do not experience a per capita percentage of daily COVID deaths above 0.0025. However, there are few outliers, whose upper limit is 0.0075. 


##### Per Capita Percentage of Vaccination Counts vs GDP Per Capita for each country. 

```{r, warnings=FALSE, message=FALSE, echo = FALSE}
covid_lines_3 <- highlight_key(covid_worldwide_9)

gg_covid_3 <- ggplot (data = covid_lines_3, aes(x=date, y = new_vaccinations_smoothed_capita, group = country)) +
  geom_line(aes(color = continent,            
                text = paste("Country: ", country, 
                             "<br>Date: ", date, 
                              "<br> Per capita percentage of new covid vaccinations", new_vaccinations_smoothed_capita, "%",
                              " <br> GDP per capita", gdp_per_capita
                        )), show.legend = FALSE)+
  xlab("Date") + ylab("Per capita percentage of covid vaccinations")+ 
  ggtitle("Per Capita Vaccinations Trend") +
  theme_bw()

 bscols(widths = c(3,9),
        list(
              filter_select("id", label = "Select a country", covid_lines, ~country),
              filter_slider(id = "slider_gdp_per_capita_2", label = " GDP Per Capita", 
                            covid_lines_3, column = ~gdp_per_capita)
             ), 
          ggplotly(gg_covid_3, dynamicTicks = TRUE, tooltip = c("text"),  
           tooltipoptions = list(placement = "bottom")))
```


In this line chart, like in the previous graphs, all the lines are stacked on top of each other, which makes it challenging to draw any conclusions at first glance. However, with further analysis, we can still gather valuable insights. The general trend in this chart shows that the per capita percentage of daily COVID vaccinations seems to decrease towards the end of 2022.

Moreover, when we examine countries with a high GDP per capita (above 72,000), the per capita percentage of daily COVID vaccinations ranges between 0 and 1.4. Among countries with a GDP per capita between 31,000 and 75,000, the range appears to be between 0 and 2.5. For countries with a low GDP per capita (defined as being between 675 dollars and 35000), the range of per capita percentage of daily COVID vaccinations varies greatly between 0 and 12%, with Bhutan being the outlier. For most low GDP countries, the rate of per capita percentage of daily COVID vaccinations is between 0 and 4%. However, it's worth noting that other factors beyond GDP per capita may influence these trends, and further analysis is necessary to identify them.

#### Tools and Inherent Limitations associated with the tools.
Crosstalk, according to Chapter 16 of https://plotly-r.com/client-side-linking.html  is a framework for creating widgests and dashboards that allow users to filter, sort and group data, and then visualize the results in real-time.Consequently, it allows one to embed an interactive histogram into an html page generated from an R Markdown document, which is what I needed. 

Due to its computational demands, crosstalk isn't\ suitable for larger datasets with a high number of daily observations. Thus, my analysis of the trend of different COVID observations was limited.

####  Observations: 

To draw more definitive conclusions from the dataset, it is essential to conduct a more focused analysis that considers one factor at a time. By reducing the scope of analysis, I would have been able to make more specific arguments rather than the general observations I made above.

#### Inherent Limitations to Making Conclusive Findings: 
During the data wrangling process, it became apparent that for several months at a time, many countries had no COVID-related observations reported. This lack of reported data differs from a zero observation and limits my ability to analyze the data and draw conclusions. One potential avenue to explore would be to exclude the countries with the highest count of missing values from the analysis.


## Emma - Covid Recovery Times

For this PUG project we chose to continue to work with COVID data on a global scale as opposed to just statewide data in Massachusetts. My goal for this project was to discover what qualities and conditions of countries were similar between those who took longer to “recover” from COVID in 2021. To do this I worked with k-means clustering and a handful of attributes in the OWID COVID dataset. I wanted specifically to use attributes that did not technically “have anything to do with” COVID or a pandemic to see how the country at its pre-pandemic level reacted. I looked for poverty as well as income data in other sources, but it was either incomplete or not in the years that I wanted so I instead stayed within the OWID dataset. I narrowed down my variables to population density, GDP per capita, the cardiovascular death rate, and diabetes prevalence for each country as they were both the most complete datasets and msot interesting to me. My next big step was to determine my `daystil` variable, which would tell me how long it took, in number of days, for countries to recover. I did some exploring on the OWID website with their distribution displays and ended up deciding on finding the number of days countries took, including all of 2020 but only evaluating in 2021, to get to one death per million. I did not evaluate all of 2020 for a few reasons: Things started out bad and got worse, and I did not want that first portion to be chosen for when countries were at one death per million; The summer allowed for much more outside time and less school with lowered rates so I wanted to evaluate recovery from a winter where people would have been inside; Countries that were affected later needed to be taken into consideration. So, I evaluated only 2021 and forward for at what point countries hit the 1 death per million mark.
```{r picking vars, include=FALSE}
#Picking information for clustered data
covidCountries <- data %>% 
  select(location, country, population_density, gdp_per_capita, cardiovasc_death_rate, diabetes_prevalence, daystil) %>%
  drop_na()
#Without Russia
covidCountriesNoR <- covidCountries %>%
  filter(country != "RUS")
#Without any day 1 countries
covidCountriesNoMin <- covidCountries %>%
  filter(daystil > 297)

#Prepping data for clustering
covidCountriesFor <- covidCountries %>%
  select(-country, -location)
#Without Russia
covidCountriesForNoR <- covidCountriesNoR %>%
  select(-country, -location)
#Without any day 1 countries
covidCountriesForNoMin <- covidCountriesNoMin %>%
  select(-country, -location)

```
I used the elbow plot to pick the number of clusters and ended up with three, in Figure 1. Four also would have been fine but I didn't think that adding the complexity of four was going to be adding much to anything I was doing, so I just went ahead with three.


*Figure 1*
``` {r determining cluster size (with Russia), echo=FALSE}
# Iterate through clustering algorithm for 10 different values of k (with Russia)
elbow_plot <- tibble(k = 1:10) %>%
  mutate(
    kmeans_results = purrr::map(k, ~kmeans(covidCountriesFor, .x)), 
    glanced = purrr::map(kmeans_results, glance)) %>% 
  # Turn `glanced` list-column into regular tibble columns
  unnest(cols = c(glanced))

# Construct elbow plot
ggplot(elbow_plot, aes(x = k, y = tot.withinss)) +
  geom_point() + 
  geom_line() +
  scale_x_continuous(breaks = 1:10) +
  labs(x = "Number of clusters (k)", 
       y = "Total within-cluster sum of squares") +
  ggtitle("Elbow plot to determine appropirate cluster size")
```


In terms of my grouping, I ended up with three clusters that were certainly different in terms of GDP per capita, cardiovascular death rate, and population density, but I had pretty close numbers for days until recovery with 312, 316, and 359 days in each group (Figure 2). I also noticed that Russia was a huge outlier in terms of days until recovery. Russia did a pretty terrible job handling the pandemic and slowing down the spread of COVID, so this does not surprise me that they were in the longest days until recovery cluster, but I was surprised by just how poorly they were recovering. I tried clustering without Russia in the picture, and did the elbow plot again for this too and decided on three clusters as well. The withins are slightly lower for one group in the data without Russia than the data with Russia, but the change in data seemed to make more of a difference in terms of the visualization than in terms of the actual statistical results so I kept Russia in the data (Figure 3). I thought the display was most interesting and easy to see in terms of different clusters when plotting GDP per capita and days until recovery. 


*Figure 2*

```{r performing kmeans clustering, echo=FALSE}
set.seed(420) #blaze it 
              #I'M KIDDING

# Perform k-means clustering with k = 3 (This is what I ended up using)
cc_kmeans3 <- covidCountriesFor %>% 
  kmeans(centers = 3, nstart = 20)

# Summarize kmeans object components
cc_kmeans3_summaries <- tidy(cc_kmeans3)
#cc_kmeans3_summaries
kmeans3table <- as.data.frame(cc_kmeans3_summaries)
kmeans3table <- kmeans3table %>%
  select(cluster, size, daystil, gdp_per_capita, population_density, cardiovasc_death_rate, diabetes_prevalence, withinss) %>%
  rename("Cluster" = cluster, "Cluster Size" = size, "Days until Recovery" = daystil
         , "GDP per Capita" = gdp_per_capita, "Population Density" = population_density
         , "Cardiovascular Death Rate" = cardiovasc_death_rate, "Diabetes Prevalence" = diabetes_prevalence
         , "Withins" = withinss)

kmeans3table %>%
  kbl(caption = "Cluster Characteristics") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```

*Figure 3*


```{r viz, warning=FALSE, echo=FALSE}

ccvizdf3 <- augment(cc_kmeans3, covidCountries)

#Visualize the cluster assignments and centroids
finalviz <- ggplot(ccvizdf3, aes(x = daystil, y = gdp_per_capita
                                 , text = paste(location,", GDP per Capita: $",gdp_per_capita," Days Until Recovery: ",daystil))) + 
  geom_point(aes(color = .cluster, shape = .cluster)) +
  geom_text_repel(aes(label = country, color = .cluster), 
                  size = 3, max.overlaps = 15, show.legend = FALSE) +
  labs(x = "Days until Recovery",
       y = "GDP in USD per Capita",
       color = "Cluster",
       shape = "Cluster") +
  theme_classic() +
  ggtitle("Cluster display of Days until Recovery vs GDP per Capita") 

ggplotly(finalviz, tooltip = "text") #set hover info
```

Finally, I removed all countries that “recovered” on day one of 2021, or in 297 days. There were many countries that were already under one death per million, and I wondered if their prevalence was messing with my data. I hesitate to make this my entire project, because there are certainly countries that did this and managed to stay in control all on their own but I think a large number of countries have this statistic because the reporting was more difficult to get a hold of. Results were very similar, in that I did not get huge differences between the number of days it took for countries to recover per group and the trends with GDP, population density, and my other variables were consistent.


For my one last sort of bonus step, I fit a multiple linear model to try to predict days until recovery, picking variables from the same set of variables I used for clustering and ending up just using GDP per capita and population density (Figure 4). It's not as nuanced as clustering is, but it was interesting to compare some more “basic” observations about days until recovery in countries – higher GDP per capita and lower population density contribute to higher numbers of days until recovery – with what my clusters seemed to communicate. Looking at the clusters (3 clusters, including Russia), I found that the highest GDP per capita and highest population density as well as lowest GDP per capita and lowest population density was grouped with the lower days until recovery, whereas the middle ground in those two respects had a higher days until recovery. Diabetes prevalence and cardiovascular death rate did not seem to follow any specific pettern of higher or lower numbers grouping with days until recovery (Figure 2).


*Figure 4*


```{r}
fit <- lm(daystil ~ gdp_per_capita  + population_density, data=covidCountries)
summary(fit)

```


I had high hopes for what my data could and would show, but I think there are some serious limitations to this project. My biggest challenge was figuring out how I was going to make my days until recovery variable. The number that I picked, 1 death per million, seems like a good metric to me but I think a better number would have been one that took the population density of the country into account. Even though this number is a per capita number, which takes into account the actual size of the population, I wonder if population density might guide me to finding different and more specific metrics. The 2020/2021 choice for when to start counting days was also a little shaky but I think the reasoning behind that is much more solid than the 1 death per million. Another thing I wish I could have implemented better is the poverty statistics I was looking to be able to cover for all countries (Instead of just SIX when I narrowed it down :( ) and something with healthcare. I was also unable to find that over the countries I wanted to predict, but I think it would have been really interesting to class levels of healthcare coverage and then use that to group countries with days until recovery. 

Ultimately I think this is a really interesting concept, and if I had better and more complete data on a wider range of country attributes like housing type, rural vs. urban populations, healthcare coverage, etc. I would definitely have a wider range of things to choose from and probably more interesting results. Were that to exist, this data could help the WHO advise countries on what to expect from a pandemic based on their current situation and how possibly to put themselves in a better position to resist one. 


## References

0. Data sets: 

Lynca: 

Edouard Mathieu, Hannah Ritchie, Lucas Rodés-Guirao, Cameron Appel, Charlie Giattino, Joe Hasell, Bobbie Macdonald, Saloni Dattani, Diana Beltekian, Esteban Ortiz-Ospina and Max Roser (2020) - "Coronavirus Pandemic (COVID-19)". Published online at OurWorldInData.org. Retrieved from: 'https://ourworldindata.org/coronavirus' [Online Resource]

1. Xie Y, Cheng J, Tan X (2023). _DT: A Wrapper of the JavaScript Library 'DataTables'_. R package version 0.27,
  <https://CRAN.R-project.org/package=DT>.

2. Wickham H, Averick M, Bryan J, Chang W, McGowan LD, François R, Grolemund G, Hayes A, Henry L, Hester J, Kuhn M,
  Pedersen TL, Miller E, Bache SM, Müller K, Ooms J, Robinson D, Seidel DP, Spinu V, Takahashi K, Vaughan D, Wilke C,
  Woo K, Yutani H (2019). “Welcome to the tidyverse.” _Journal of Open Source Software_, *4*(43), 1686.
  doi:10.21105/joss.01686 <https://doi.org/10.21105/joss.01686>.

3. Garrett Grolemund, Hadley Wickham (2011). Dates and Times Made Easy with lubridate. Journal of Statistical Software,
  40(3), 1-25. URL https://www.jstatsoft.org/v40/i03/.


4.  Wickham H, François R, Henry L, Müller K, Vaughan D (2023). _dplyr: A Grammar of Data Manipulation_. R package
  version 1.1.2, <https://CRAN.R-project.org/package=dplyr>.

5.  Wickham H, Bryan J (2023). _readxl: Read Excel Files_. R package version 1.4.2,
  <https://CRAN.R-project.org/package=readxl>.


6. Slowikowski K (2023). _ggrepel: Automatically Position Non-Overlapping Text Labels with 'ggplot2'_. R package version
  0.9.3, <https://CRAN.R-project.org/package=ggrepel>.

7. Robinson D, Hayes A, Couch S (2023). _broom: Convert Statistical Objects into Tidy Tibbles_. R package version 1.0.4,
  <https://CRAN.R-project.org/package=broom>.

8. Schloerke B, Cook D, Larmarange J, Briatte F, Marbach M, Thoen E, Elberg A, Crowley J (2021). _GGally: Extension to
  'ggplot2'_. R package version 2.1.2, <https://CRAN.R-project.org/package=GGally>.

9.  Wickham H, Henry L (2023). _purrr: Functional Programming Tools_. R package version 1.0.1,
  <https://CRAN.R-project.org/package=purrr>.

10. Zhu H (2021). _kableExtra: Construct Complex Table with 'kable' and Pipe Syntax_. R package version 1.3.4,
  <https://CRAN.R-project.org/package=kableExtra>.

11. C. Sievert. Interactive Web-Based Data Visualization with R, plotly, and shiny. Chapman and Hall/CRC Florida, 2020.

12. Wickham H, Seidel D (2022). _scales: Scale Functions for Visualization_. R package version 1.2.1,
  <https://CRAN.R-project.org/package=scales>.

13. Firke S (2023). _janitor: Simple Tools for Examining and Cleaning Dirty Data_. R package version 2.2.0,
  <https://CRAN.R-project.org/package=janitor>.

14.  R Core Team (2023). R: A language and environment for statistical computing. R Foundation for Statistical Computing,
  Vienna, Austria. URL https://www.R-project.org/.

15. Hvitfeldt E (2022). _textdata: Download and Load Various Text Datasets_. R package version 0.4.4,
  <https://CRAN.R-project.org/package=textdata>.

16. Wickham H (2022). _stringr: Simple, Consistent Wrappers for Common String Operations_. R package version 1.5.0,
  <https://CRAN.R-project.org/package=stringr>.

17.  Fellows I (2018). _wordcloud: Word Clouds_. R package version 2.6, <https://CRAN.R-project.org/package=wordcloud>.

18.  Wickham H, Vaughan D, Girlich M (2023). _tidyr: Tidy Messy Data_. R package version 1.3.0,
  <https://CRAN.R-project.org/package=tidyr>.

19  Meissner P (2019). _ical: 'iCalendar' Parsing_. R package version 0.1.6, <https://CRAN.R-project.org/package=ical>.

20. Hughes E (2022). _tidytuesdayR: Access the Weekly 'TidyTuesday' Project Dataset_. R package version 1.0.2,
  <https://CRAN.R-project.org/package=tidytuesdayR>.

21. Chang W (2021). _shinythemes: Themes for Shiny_. R package version 1.2.0,
  <https://CRAN.R-project.org/package=shinythemes>.

22. Gagolewski M (2022). “stringi: Fast and portable character string processing in R.” _Journal of Statistical
  Software_, *103*(2), 1-59. doi:10.18637/jss.v103.i02 <https://doi.org/10.18637/jss.v103.i02>.

23. Arnold J (2021). _ggthemes: Extra Themes, Scales and Geoms for 'ggplot2'_. R package version 4.2.4,
  <https://CRAN.R-project.org/package=ggthemes>.

24.  Auguie B (2017). _gridExtra: Miscellaneous Functions for "Grid" Graphics_. R package version 2.3,
  <https://CRAN.R-project.org/package=gridExtra>.
  
25 Yihui Xie (2023). knitr: A General-Purpose Package for Dynamic Report Generation in R. R package version 1.42.

26. Müller K, Ooms J, James D, DebRoy S, Wickham H, Horner J (2022). _RMariaDB: Database Interface and MariaDB Driver_. R
  package version 1.2.2, <https://CRAN.R-project.org/package=RMariaDB>.

27. Wickham H, Hester J, Bryan J (2023). _readr: Read Rectangular Text Data_. R package version 2.1.4,
  <https://CRAN.R-project.org/package=readr>.
  
28. Pebesma, E., 2018. Simple Features for R: Standardized Support for Spatial Vector Data. The R Journal 10 (1),
  439-446, https://doi.org/10.32614/RJ-2018-009

29. Wickham H (2022). _rvest: Easily Harvest (Scrape) Web Pages_. R package version 1.0.3,
  <https://CRAN.R-project.org/package=rvest>.

30. Meissner P, Ren K (2020). _robotstxt: A 'robots.txt' Parser and 'Webbot'/'Spider'/'Crawler' Permissions Checker_. R
  package version 0.7.13, <https://CRAN.R-project.org/package=robotstxt>.
  
31. Bivand R, Rundel C (2023). _rgeos: Interface to Geometry Engine - Open Source ('GEOS')_. R package version 0.6-2,
  <https://CRAN.R-project.org/package=rgeos>.
  
32.South, Andy 2011 rworldmap: A New R package for Mapping Global Data. The R Journal Vol. 3/1 : 35-43.

33. South A (2012). _rworldxtra: Country boundaries at high resolution._. R package version 1.01,
  <https://CRAN.R-project.org/package=rworldxtra>.

34. Cheng J, Sievert C (2021). _crosstalk: Inter-Widget Interactivity for HTML Widgets_. R package version 1.2.0,
  <https://CRAN.R-project.org/package=crosstalk>.

35. Vaidyanathan R, Xie Y, Allaire J, Cheng J, Sievert C, Russell K (2023). _htmlwidgets: HTML Widgets for R_. R package
  version 1.6.2, <https://CRAN.R-project.org/package=htmlwidgets>.

36. Sievert C, Cheng J (2022). _bslib: Custom 'Bootstrap' 'Sass' Themes for 'shiny' and 'rmarkdown'_. R package version
  0.4.2, <https://CRAN.R-project.org/package=bslib>.

37. Lin G (2023). _reactable: Interactive Data Tables for R_. R package version 0.4.4,
  <https://CRAN.R-project.org/package=reactable>.

38. Cheng J, Karambelkar B, Xie Y (2023). _leaflet: Create Interactive Web Maps with the JavaScript 'Leaflet' Library_. R
  package version 2.1.2, <https://CRAN.R-project.org/package=leaflet>.


```{r, warnings=FALSE, message = FALSE, echo = FALSE, eval = FALSE}
citation("DT")
citation("tidyverse")
citation("lubridate")
citation("dplyr")
citation("readxl")
citation("ggrepel")
citation("broom")
citation("GGally")
citation("purrr")
citation("kableExtra")
citation("plotly")
citation("scales")
citation("janitor")
citation("datasets")
citation("textdata")
citation("stringr")
citation("wordcloud")
citation("tidyr")
citation("ical")
citation("tidytuesdayR")
citation("shinythemes")
citation("stringi")
citation("ggthemes")
citation("gridExtra") 
citation("knitr")
citation("ggplot2")
citation("RMariaDB")
# help with extracting the right data frames from xlsx
citation("readr")
citation("sf")
citation("rvest") #for web scrapijng
citation("robotstxt") #checking if paths are allowed
citation("rgeos")
citation("rworldmap")
citation("rworldxtra")
citation("crosstalk") #for crosstalk. 
citation("htmlwidgets")
citation("bslib") # framework that allows one to style their Shiny applications and R Markdown documents with pre-build Bootstrap (open-source library created by Twitter) themes.
citation("reactable")
citation("leaflet")

```

